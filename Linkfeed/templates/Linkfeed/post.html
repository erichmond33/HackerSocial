{% extends "Linkfeed/layouts.html" %}
{% load static %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'Linkfeed/post.css' %}">

    <style>
        .child-comment {
            margin-left: 40px; /* Adjust this value to your preference */
        }
        
    </style>
    
    
{% endblock %}

{% block nav %}
<a href="{% url 'current_user_feed'%}" class="">Feed</a>
<a href="{% url 'current_user_profile'%}" class="">Profile</a>
{% endblock %}


{% block body %}
<!-- Move the "Posted by Lime" section outside the card and center it -->
<div class="post-header text-center mb-3">
    <h3>Posted by {{ post.user.username }}:</h3>
</div>
<div class="card post-container">
    <div class="card-body">
        <!-- Keep the title inside the card -->
        <h2 class="post-title">
            {% if post.title %}
                {{ post.title }}
            {% else %}
                Untitled
            {% endif %}
        </h2>
        <!-- Move the post body inside the card -->
        <div class="post-body post-body-border">
            {{ post.body|linebreaks }}
        </div>
        <!-- Add line between post body and comments -->
        <hr>
        <!-- Likes section -->
        <div class="likes-text">
            Likes: {{ total_likes }}
            <!-- Button to toggle the add comment popup -->
            <button class="btn btn-info" onclick="toggleAddCommentPopup()">Add Comment</button>
            
            <!-- Button to toggle the edit post popup -->
            {% if request.user == post.user %}
                <button class="btn btn-secondary" onclick="toggleEditPostPopup()">Edit Post</button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit post popup form -->
<div id="editPostPopup" class="modal" style="display: none;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Post</h5>
                <button type="button" class="close" onclick="toggleEditPostPopup()">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editPostForm" method="post" action="{% url 'edit_post' post.id %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="post_title">Title:</label>
                        <input type="text" class="form-control" name="post_title" value="{{ post.title }}">
                    </div>
                    <div class="form-group">
                        <label for="post_body">Body:</label>
                        <textarea class="form-control" name="post_body" rows="10">{{ post.body }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-success">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add comment popup form -->
<div id="addCommentPopup" class="modal" style="display: none;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Comment</h5>
                <button type="button" class="close" onclick="toggleAddCommentPopup()">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addCommentForm" method="post" action="{% url 'add_comment' post.id %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="comment_body">Comment:</label>
                        <textarea class="form-control" name="comment_body" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>
    </div>
</div>

Comments section
<div class="comments-dropdown comment-border">
    <!-- Render comments here -->
    <div class="scrollable-comments">
        {% for comment in post.comments.all %}
            {% if not comment.parent_comment %}
                <div class="card comment-container">
                    <div class="card-body">
                        <p id="comment-username" class="comment-username">Posted by: {{ comment.user.username }} - {{ comment.timestamp }}</p>
                        <p>{{ comment.body }}</p>
                        <!-- Add delete button for comment with confirmation -->
                        {% if request.user == post.user or request.user == comment.user %}
                            <form id="deleteCommentForm{{ comment.id }}" action="{% url 'delete_comment' comment.id %}" method="post">
                                {% csrf_token %}
                                <button type="button" class="btn btn-danger" onclick="confirmDelete('{{ comment.id }}')">Delete</button>
                            </form>
                        {% endif %}
                        <form method="post" action="{% url 'add_comment' post_id=post.id %}" style="margin-left: 20px;">
                            {% csrf_token %}
                            <input type="hidden" name="parent_comment_id" value="{{ comment.id }}">
                            <textarea name="comment_body"></textarea>
                            <button type="submit">Reply</button>
                        </form>
                    </div>
                </div>
            {% endif %}
            <!-- Nested replies section -->
            {% for reply in comment.replies.all %}
                <div class="card comment-container child-comment">
                    <div class="card-body">
                        <p id="comment-username" class="comment-username">Posted by: {{ reply.user.username }} - {{ reply.timestamp }}</p>
                        <p>{{ reply.body }}</p>
                        <!-- Add delete button for reply with confirmation -->
                        {% if request.user == post.user or request.user == reply.user %}
                            <form id="deleteCommentForm{{ reply.id }}" action="{% url 'delete_comment' reply.id %}" method="post">
                                {% csrf_token %}
                                <button type="button" class="btn btn-danger" onclick="confirmDelete('{{ reply.id }}')">Delete</button>
                            </form>
                        {% endif %}
                        <form method="post" action="{% url 'add_comment' post_id=post.id %}" style="margin-left: 20px;">
                            {% csrf_token %}
                            <input type="hidden" name="parent_comment_id" value="{{ reply.parent_comment.id }}">
                            <textarea name="comment_body"></textarea>
                            <button type="submit">Reply</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        {% empty %}
            <p>No comments yet.</p>
        {% endfor %}
    </div>
</div>




<!-- JavaScript to toggle edit post popup -->
<script>
    // Function to toggle edit post popup
    function toggleEditPostPopup() {
        var popup = document.getElementById("editPostPopup");
        if (popup.style.display === "none") {
            popup.style.display = "block";
        } else {
            popup.style.display = "none";
        }
    }

    // Function to toggle add comment popup
    function toggleAddCommentPopup() {
        var popup = document.getElementById("addCommentPopup");
        if (popup.style.display === "none") {
            popup.style.display = "block";
        } else {
            popup.style.display = "none";
        }
    }

    // Function to confirm delete before submitting delete form
    function confirmDelete(commentId) {
        if (confirm("Are you sure you want to delete this comment?")) {
            document.getElementById("deleteCommentForm" + commentId).submit();
        }
    }

    // jQuery to toggle reply form
    $(document).ready(function() {
        $('.reply-button').click(function() {
            $(this).siblings('.reply-form').toggle();
        });
    });
</script>

{% endblock body %}
